version: '3.5'

services:
  nginx:
    hostname: nginx
    container_name: nde-nginx
    image: nginx:alpine
    ports:
      - 80:80
      - 443:443
    # links: #not needed
    #   - mail
    volumes:
      - ~/prj:/var/www
      - sock:/run/php
      - ~/nde/cfg/nginx:/etc/nginx/conf.d
      - ~/nde/cfg/nginx/cert:/etc/nginx/cert
      - ~/nde/cfg/d.bashrc:/etc/bash.bashrc

  php:
    hostname: php
    container_name: nde-php
    build: 
      context: ~/nde/cfg/php
      dockerfile: ~/nde/debian/Dockerfile
      args:
        MUID: $MUID
        MGID: $MUID
    user: "www-data:www-data" #Unix only
    # links: #not needed
    #   - mail
    #   - mysql5
    #   - mysql8
    #   - beanstalk
    volumes:
      - ~/prj:/var/www
      - sock:/run/php
      - ~/nde/cfg/d.bashrc:/etc/bash.bashrc

  mysql5:
    hostname: mysql5
    container_name: nde-mysql-5
    image: mysql:5
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
      - --sql_mode=ONLY_FULL_GROUP_BY
      # - --explicit_defaults_for_timestamp
      # - --innodb_use_native_aio=0
      # - --innodb_log_checksums=ON
    ports:
      - 3306:3306 #for mysql client
    volumes:
      - ~/nde/db/mysql5:/var/lib/mysql
      - ~/nde/cfg/d.bashrc:/etc/bash.bashrc
    environment:
      MYSQL_ROOT_PASSWORD: secret

  # mysql8:
  #   hostname: mysql8
  #   container_name: nde-mysql-8
  #   image: mysql
  #   command:
  #     - --character-set-server=utf8mb4
  #     - --collation-server=utf8mb4_unicode_ci
  #     - --default-authentication-plugin=mysql_native_password
  #     - --sql_mode=ONLY_FULL_GROUP_BY
  #    # - --explicit_defaults_for_timestamp
  #    # - --innodb_use_native_aio=0
  #    # - --innodb_log_checksums=ON
  #   ports:
  #     - 3308:3306
  #   volumes:
  #     - ~/nde/db/mysql8:/var/lib/mysql
  #     - ~/nde/cfg/d.bashrc:/etc/bash.bashrc
  #   environment:
  #     MYSQL_ROOT_PASSWORD: secret

  #   beanstalk:
  #    hostname# : beanstalk
  #    container_name: nd# e-beanstalk
  #    image: schicklin# g/beanstalkd
  #    volumes:
  #      - projects:/var/www
  #    # ports:
  #      # - 11300:11300
  
  mail:
    hostname: mail
    container_name: nde-mail
    image: mailhog/mailhog
    # ports: 
      # - 1025:1025 # smtp server
      # - 8025:8025 # web ui

  dns:
    hostname: dns
    container_name: nde-dns
    restart: always
    image: andyshinn/dnsmasq
    volumes:
      - ~/nde/cfg/dnsmasq.conf:/etc/dnsmasq.conf
    ports:
     - "53:53/udp"
    cap_add:
      - NET_ADMIN

volumes:
  sock:
    driver_opts:
      o: uid=$MUID,gid=$MGID
      type: tmpfs
      device: tmpfs
